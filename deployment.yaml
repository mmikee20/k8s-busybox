apiVersion: apps/v1
kind: Deployment
metadata:
  name: busybox-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: busybox
  template:
    metadata:
      labels:
        app: busybox
    spec:
      volumes:
        - name: work
          emptyDir: {}
      containers:
        - name: busybox
          image: busybox:1.36
          imagePullPolicy: IfNotPresent
          command: ["/bin/sh", "-c"]
          args:
            - |
              while true; do
                line="$(date) - $MESSAGE"
                echo "$line" | tee -a /work/busybox.log
                sleep 5;
              done
          env:
            - name: MESSAGE
              valueFrom:
                configMapKeyRef:
                  name: busybox-config
                  key: MESSAGE
          volumeMounts:
            - name: work
              mountPath: /work
          livenessProbe:
            exec:
              command: ["/bin/sh", "-c", "pidof sh >/dev/null"]
            initialDelaySeconds: 5
            periodSeconds: 10
            failureThreshold: 3
          resources:
            requests:
              cpu: 10m
              memory: 16Mi
            limits:
              cpu: 100m
              memory: 64Mi
